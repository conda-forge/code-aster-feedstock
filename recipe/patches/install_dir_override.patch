Subject: [PATCH] fix: update installation path for Aster library to support Python environment
refactor: update installation paths for Windows and conda builds
---
Index: bibc/wscript
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/bibc/wscript b/bibc/wscript
--- a/bibc/wscript	(revision 38bd1c86695b9720108b6d2e1da5921f217d93f4)
+++ b/bibc/wscript	(revision 0d6d8f3bc52c8ffe11712bccbb3f15c71e54cf4b)
@@ -23,7 +23,7 @@
 from pathlib import Path
 
 
-from waflib import Configure, TaskGen, Utils, Logs
+from waflib import Configure, TaskGen, Utils, Logs, Build
 
 
 def options(self):
@@ -143,7 +143,8 @@
     if not ctx.cmd.startswith("install"):
         return
 
-    asterlibdir = Path(ctx.env.ASTERLIBDIR)
+    python_install_path = ctx.env.SPDIR if ctx.env.SPDIR else ctx.env.ASTERLIBDIR
+    asterlibdir = Path(python_install_path)
 
     extlib = "so"
     mods = ["aster", "aster_core", "aster_fonctions"]
@@ -185,6 +186,13 @@
         "PETSC",
     ]
     get_srcs = self.path.get_src().ant_glob
+
+    # Determine install paths - DLLs go to BINDIR on Windows, libs stay in LIBDIR
+    if self.env.ASTER_PLATFORM_MSVC64:
+        lib_install_path = env.ASTERBINDIR
+    else:
+        lib_install_path = env.ASTERLIBDIR
+
     # compile *.c
     self(
         features=("c cstlib" if self.env.ASTER_PLATFORM_MINGW else "c cshlib"),
@@ -195,7 +203,7 @@
         defines="",
         use=use,
         env=env.derive(),
-        install_path=env.ASTERLIBDIR,
+        install_path=lib_install_path,
     )
 
 
@@ -206,6 +214,15 @@
         use.append("DBGHELP")
     if env.BUILD_MFRONT:
         use.append("astermfront")
+
+    # Determine install path for aster.dll
+    # On MSVC, DLLs go to BINDIR, on other platforms to SPDIR/ASTERLIBDIR
+    python_install_path = env.SPDIR if env.SPDIR else env.ASTERLIBDIR
+    if self.env.ASTER_PLATFORM_MSVC64:
+        install_path = env.ASTERBINDIR
+    else:
+        install_path = python_install_path
+
     # {bibfor, bibc, bibcxx}/*.o
     if self.env.ASTER_PLATFORM_MINGW:
         # fix circular dependencies between bibc.a and bibfor.a
@@ -222,7 +239,7 @@
         defines="_MAIN_=_unused_main_",  #'ASTER_WITHOUT_PYMOD',
         env=env.derive(),
         use=use,
-        install_path=env.ASTERLIBDIR,
+        install_path=install_path,
     )
 
     self.add_post_fun(post_install_links)
Index: bibcxx/wscript
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/bibcxx/wscript b/bibcxx/wscript
--- a/bibcxx/wscript	(revision 38bd1c86695b9720108b6d2e1da5921f217d93f4)
+++ b/bibcxx/wscript	(revision 177e22af8fbe821b37329db860028d3ac9d425c2)
@@ -60,6 +60,12 @@
             use=["BIBCXX", "PYBIND11", "MFRONT", "PYEXT", "CXX"],
         )
 
+    # Determine install paths - DLLs go to BINDIR on Windows, libs stay in LIBDIR
+    if self.env.ASTER_PLATFORM_MSVC64:
+        lib_install_path = env.ASTERBINDIR
+    else:
+        lib_install_path = env.ASTERLIBDIR
+
     self(
         features=("cxx" if self.env.ASTER_PLATFORM_MINGW else "cxx cxxshlib"),
         name="asterbibcxx",
@@ -81,7 +87,7 @@
             "PETSC",
         ],
         env=env.derive(),
-        install_path=env.ASTERLIBDIR,
+        install_path=lib_install_path,
     )
 
 
Index: bibfor/wscript
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/bibfor/wscript b/bibfor/wscript
--- a/bibfor/wscript	(revision 38bd1c86695b9720108b6d2e1da5921f217d93f4)
+++ b/bibfor/wscript	(revision 177e22af8fbe821b37329db860028d3ac9d425c2)
@@ -57,6 +57,13 @@
 
     src_i8 = get_srcs("**/*.F90", excl="third_party_interf/*.F90")
     src_ext = get_srcs("third_party_interf/*.F90")
+
+    # Determine install paths - DLLs go to BINDIR on Windows, libs stay in LIBDIR
+    if self.env.ASTER_PLATFORM_MSVC64:
+        lib_install_path = env.ASTERBINDIR
+    else:
+        lib_install_path = env.ASTERLIBDIR
+
     # use int64 as default integer...
     self(
         features=("fc fcstlib" if self.env.ASTER_PLATFORM_MINGW else "fc fcshlib"),
@@ -66,7 +73,7 @@
         source=src_i8,
         use=use + ["INT64"],
         env=env.derive(),
-        install_path=env.ASTERLIBDIR,
+        install_path=lib_install_path,
     )
     # ... except for subroutines linked against external libraries
     self(
@@ -78,7 +85,7 @@
         defines=["WITHOUT_INT64"],
         use=use,
         env=env.derive(),
-        install_path=env.ASTERLIBDIR,
+        install_path=lib_install_path,
     )
 
 
Index: catalo/wscript
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/catalo/wscript b/catalo/wscript
--- a/catalo/wscript	(revision 38bd1c86695b9720108b6d2e1da5921f217d93f4)
+++ b/catalo/wscript	(revision 177e22af8fbe821b37329db860028d3ac9d425c2)
@@ -32,8 +32,13 @@
     env = self.all_envs[self.variant]  # .derive()
     if self.variant == "debug":
         env.OPTDEBUG = "-g"
+
+    # elem.1 is a JEVEUX database file that must be in ASTERLIBDIR (lib directory)
+    # not in site-packages, as the runtime code expects to find it at lib/elem.1
+    elem_install_path = env.ASTERLIBDIR
+
     if self.cmd.startswith("uninstall"):
-        elem = osp.join(env.ASTERLIBDIR, "elem.1")
+        elem = osp.join(elem_install_path, "elem.1")
         try:
             os.remove(elem)
         except OSError:
@@ -48,7 +53,7 @@
         env=env,
         vars=["CATALO_CMD"],
         use="asterlib",
-        install_path=env.ASTERLIBDIR,
+        install_path=elem_install_path,
     )
 
 
Index: code_aster/wscript
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/code_aster/wscript b/code_aster/wscript
--- a/code_aster/wscript	(revision 38bd1c86695b9720108b6d2e1da5921f217d93f4)
+++ b/code_aster/wscript	(revision 177e22af8fbe821b37329db860028d3ac9d425c2)
@@ -83,12 +83,15 @@
     get_srcs = self.path.get_src().ant_glob
     env = self.all_envs[self.variant]
 
+    # Use SPDIR if provided (for conda/rattler builds), otherwise use ASTERLIBDIR
+    install_base = env.SPDIR if env.SPDIR else env.ASTERLIBDIR
+
     self(
         features="py",
         name="code_aster_py",
         source=get_srcs("**/*.py"),
         install_from=".",
-        install_path=osp.join(env.ASTERLIBDIR, "code_aster"),
+        install_path=osp.join(install_base, "code_aster"),
     )
 
     self(
@@ -96,7 +99,7 @@
         name="pytmpl",
         source="aster_pkginfo.pytmpl",
         target="aster_pkginfo.py",
-        install_path=osp.join(env.ASTERLIBDIR, "code_aster", "Utilities"),
+        install_path=osp.join(install_base, "code_aster", "Utilities"),
         VERSION_INFO=pformat(env["ASTER_VERSION"]),
     )
 
@@ -105,7 +108,7 @@
         name="pytmpl",
         source="aster_version.pytmpl",
         target="aster_version.py",
-        install_path=osp.join(env.ASTERLIBDIR, "code_aster", "Cata"),
+        install_path=osp.join(install_base, "code_aster", "Cata"),
         VERSION_INFO=pformat(env["ASTER_VERSION"]),
     )
 
Index: libs/wscript
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/libs/wscript b/libs/wscript
--- a/libs/wscript	(revision 38bd1c86695b9720108b6d2e1da5921f217d93f4)
+++ b/libs/wscript	(revision 177e22af8fbe821b37329db860028d3ac9d425c2)
@@ -25,7 +25,11 @@
 def configure(self):
     if not self.env["PYTHON"]:
         self.fatal("load python tool first")
-    self.env.LIBPATH_ASTERGC = self.env.ASTERLIBDIR
+    # On Windows MSVC, DLLs should go to BINDIR, otherwise to ASTERLIBDIR
+    if self.env.ASTER_PLATFORM_MSVC64:
+        self.env.LIBPATH_ASTERGC = self.env.ASTERBINDIR
+    else:
+        self.env.LIBPATH_ASTERGC = self.env.ASTERLIBDIR
 
 
 def build(self):
Index: mfront/wscript
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/mfront/wscript b/mfront/wscript
--- a/mfront/wscript	(revision 38bd1c86695b9720108b6d2e1da5921f217d93f4)
+++ b/mfront/wscript	(revision 177e22af8fbe821b37329db860028d3ac9d425c2)
@@ -74,6 +74,12 @@
         lmfront = get_srcs("**/*.mfront")
         lst = [i.name for i in lmfront]
 
+        # Determine install paths - DLLs go to BINDIR on Windows, libs stay in LIBDIR
+        if self.env.ASTER_PLATFORM_MSVC64:
+            lib_install_path = env.ASTERBINDIR
+        else:
+            lib_install_path = env.ASTERLIBDIR
+
         self(
             features="cxx cxxshlib",
             name="asterbehaviour",
@@ -81,7 +87,7 @@
             includes=[osp.join(osp.splitext(i)[0], "include") for i in lst],
             target=env["ASTER_BEHAVIOUR_LIB"],
             rpath="$ORIGIN",
-            install_path=env.ASTERLIBDIR,
+            install_path=lib_install_path,
             env=env.derive(),
             use=["MFRONT", "MFRONT_ONLY", "CXX"],
         )
Index: run_aster/wscript
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/run_aster/wscript b/run_aster/wscript
--- a/run_aster/wscript	(revision 38bd1c86695b9720108b6d2e1da5921f217d93f4)
+++ b/run_aster/wscript	(revision 177e22af8fbe821b37329db860028d3ac9d425c2)
@@ -32,10 +32,13 @@
     get_srcs = self.path.get_src().ant_glob
     env = self.all_envs[self.variant]
 
+    # Use SPDIR if provided (for conda/rattler builds), otherwise use ASTERLIBDIR
+    install_base = env.SPDIR if env.SPDIR else env.ASTERLIBDIR
+
     self(
         features="py",
         name="run_aster_py",
         source=get_srcs("**/*.py"),
         install_from=".",
-        install_path=osp.join(env.ASTERLIBDIR, "run_aster"),
+        install_path=osp.join(install_base, "run_aster"),
     )
Index: wscript
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/wscript b/wscript
--- a/wscript	(revision 38bd1c86695b9720108b6d2e1da5921f217d93f4)
+++ b/wscript	(revision 177e22af8fbe821b37329db860028d3ac9d425c2)
@@ -152,7 +152,29 @@
         default=os.environ.get("ENABLE_MINGW", "0") != "0",
         help="enable cross compilation for mingw",
     )
-
+    # MSVC Options
+    group.add_option(
+        "--spdir",
+        dest="spdir",
+        default=None,
+        help="Python site-packages directory for conda/rattler builds "
+             "[default: auto-detect from Python]",
+    )
+    group.add_option(
+        "--bindir",
+        dest="bindir",
+        default=None,
+        help="Binary directory for DLL files on Windows conda/rattler builds "
+             "[default: PREFIX/bin]",
+    )
+    group.add_option(
+        "--disable-aster-subdir",
+        dest="disable_aster_subdir",
+        action="store_true",
+        default=False,
+        help="Disable the /aster subdirectory in installation paths "
+             "(useful for conda/rattler builds where files should go directly to lib)",
+    )
     group = self.add_option_group("code_aster options")
 
     self.load("parallel", tooldir="waftools")
@@ -326,6 +348,8 @@
 
 
 def build(self):
+    env = self.env.derive()
+
     fc._use_custom_sig = self.options.custom_fc_sig
     # shared the list of dependencies between bibc/bibfor
     # the order may be important
@@ -336,9 +360,21 @@
         )
     if self.cmd.startswith("install"):
         # because we can't know which files are obsolete `rm *.py{,c,o}`
-        remove_previous(
-            self.root.find_node(self.env.ASTERLIBDIR), ["**/*.py", "**/*.pyc", "**/*.pyo"]
-        )
+        # When using SPDIR (conda builds), only clean our specific subdirectories
+        # not the entire site-packages directory
+        if env.SPDIR:
+            # Only clean code_aster and run_aster subdirectories
+            code_aster_dir = self.root.find_node(osp.join(env.SPDIR, "code_aster"))
+            run_aster_dir = self.root.find_node(osp.join(env.SPDIR, "run_aster"))
+            if code_aster_dir:
+                remove_previous(code_aster_dir, ["**/*.py", "**/*.pyc", "**/*.pyo"])
+            if run_aster_dir:
+                remove_previous(run_aster_dir, ["**/*.py", "**/*.pyc", "**/*.pyo"])
+        else:
+            # Traditional installation - clean entire ASTERLIBDIR
+            remove_previous(
+                self.root.find_node(self.env.ASTERLIBDIR), ["**/*.py", "**/*.pyc", "**/*.pyo"]
+            )
         remove_previous(
             self.root.find_node(self.env.ASTERDATADIR),
             ["datg/**/*", "materiau/**/*", "tests_data/**/*"],
@@ -356,9 +392,12 @@
     self.recurse("catalo")
     self.recurse("data")
     self.recurse("astest")
-
+    if env.SPDIR:
+        sp_dir = self.env.SPDIR
+    else:
+        sp_dir = self.env.ASTERLIBDIR
     self.install_as(
-        osp.join(self.env.ASTERLIBDIR, "code_aster", "Utilities", "aster_config.py"),
+        osp.join(sp_dir, "code_aster", "Utilities", "aster_config.py"),
         ["aster_config.py"],
     )
 
@@ -452,13 +491,40 @@
 @Configure.conf
 def set_installdirs(self):
     # set the installation subdirectories
-    norm = lambda path: osp.normpath(osp.join(path, "aster"))
-    self.env["ASTERLIBDIR"] = norm(self.env.LIBDIR)
-    self.env["ASTERINCLUDEDIR"] = norm(self.env.INCLUDEDIR)
-    self.env["ASTERDATADIR"] = norm(self.env.DATADIR)
+    # Check if --libdir was explicitly provided and override LIBDIR if needed
+    # The gnu_dirs module defaults to lib64 on 64-bit systems, but conda/rattler
+    # builds typically expect lib to be used
+    if self.options.libdir:
+        # User explicitly set libdir, use it
+        self.env.LIBDIR = self.options.libdir
+
+    # Check if --spdir was explicitly provided for conda/rattler builds
+    if self.options.spdir:
+        self.env.SPDIR = self.options.spdir
+
+    # Check if --bindir was explicitly provided for Windows DLL installation
+    if self.options.bindir:
+        self.env.BINDIR = self.options.bindir
+    else:
+        # Default to PREFIX/bin if not specified
+        self.env.BINDIR = osp.join(self.env.PREFIX, "bin")
+
+    # For conda/rattler builds, we don't want the /aster subdirectory for libraries
+    # but we DO want it for data files (tests, profile.sh, etc.)
+    if self.options.disable_aster_subdir:
+        norm_lib = lambda path: osp.normpath(path)
+        norm_data = lambda path: osp.normpath(osp.join(path, "aster"))
+    else:
+        norm_lib = lambda path: osp.normpath(osp.join(path, "aster"))
+        norm_data = lambda path: osp.normpath(osp.join(path, "aster"))
+
+    self.env["ASTERLIBDIR"] = norm_lib(self.env.LIBDIR)
+    self.env["ASTERBINDIR"] = self.env.BINDIR
+    self.env["ASTERINCLUDEDIR"] = norm_data(self.env.INCLUDEDIR)
+    self.env["ASTERDATADIR"] = norm_data(self.env.DATADIR)
     if not self.env.LOCALEDIR:
         self.env.LOCALEDIR = osp.join(self.env.PREFIX, "share", "locale")
-    self.env["ASTERLOCALEDIR"] = norm(self.env.LOCALEDIR)
+    self.env["ASTERLOCALEDIR"] = norm_data(self.env.LOCALEDIR)
     # set relative paths for profile.sh
     for var in ("LIBDIR", "DATADIR", "LOCALEDIR"):
         self.env["RELATIVE_" + var] = osp.relpath(self.env["ASTER" + var], self.env["PREFIX"])
